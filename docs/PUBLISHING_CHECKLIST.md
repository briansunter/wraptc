# Publishing Setup Checklist

Use this checklist to set up automated npm publishing with Bitwarden Secrets Manager for the first time.

## Initial Setup

- [ ] **Repository is on GitHub**
  - Repository: `https://github.com/briansunter/wraptc`
  - Branch: `master`

- [ ] **npm account exists**
  - Sign up at https://www.npmjs.com if needed
  - Verify your email address

## Bitwarden Secrets Manager Setup

- [ ] **Create BWS Project**
  ```bash
  bws project create "npm-publishing-wraptc"
  # Returns: <BWS_PROJECT_ID>
  # Save this for later!
  ```

- [ ] **Create npm Automation Token**
  1. Go to https://www.npmjs.com/settings/tokens
  2. Click "Create New Token"
  3. Select "Automation" type (required for CI/CD - bypasses 2FA!)
  4. Give it a name like "CI/CD - wraptc"
  5. Copy the token (you won't see it again!)

- [ ] **Store NPM Token in BWS**
  ```bash
  BWS_ACCESS_TOKEN='<your-bws-access-token>' \
  bws secret create NPM_TOKEN "<npm-automation-token>" <BWS_PROJECT_ID>
  # Returns: <BWS_SECRET_ID>
  # Save this for GitHub Secrets!
  ```

- [ ] **Create Machine Account in BWS**
  1. Go to Bitwarden Secrets Manager web vault
  2. Navigate to **Machine Accounts**
  3. Create new machine account for GitHub Actions
  4. Grant access to the project
  5. Generate access token: `<BWS_ACCESS_TOKEN>`

## GitHub Repository Setup

- [ ] **Add BWS Secrets to GitHub**
  1. Go to: https://github.com/briansunter/wraptc/settings/secrets/actions
  2. Add `BWS_ACCESS_TOKEN`:
     - Name: `BWS_ACCESS_TOKEN`
     - Value: (paste your BWS machine account access token)
  3. Add `BWS_NPM_TOKEN_ID`:
     - Name: `BWS_NPM_TOKEN_ID`
     - Value: (paste the Secret ID from bws secret create)

- [ ] **(Optional) Add Codecov Token**
  1. Sign up at https://codecov.io
  2. Add your repository
  3. Get your upload token from: https://codecov.io/gh/briansunter/wraptc/settings
  4. Add `CODECOV_TOKEN` to GitHub Secrets

## Verification

- [ ] **Install dependencies**
  ```bash
  bun install
  ```

- [ ] **Run tests locally**
  ```bash
  bun test
  ```

- [ ] **Run build**
  ```bash
  bun run build
  ```

- [ ] **Run lint**
  ```bash
  bun run lint
  ```

- [ ] **Test dry-run release**
  ```bash
  bun run release:dry-run
  ```

## First Release

Once setup is complete, push to master to trigger the first release:

- [ ] **Ensure you're on master branch**
  ```bash
  git checkout master
  git pull origin master
  ```

- [ ] **Make a commit with conventional commit message**
  ```bash
  # Example: first release commit
  git commit --allow-empty -m "chore: initial release v1.0.0"
  ```

- [ ] **Push to master**
  ```bash
  git push origin master
  ```

- [ ] **Monitor GitHub Actions**
  1. Go to: https://github.com/briansunter/wraptc/actions
  2. Watch the "Publish Packages" workflow
  3. Check that all jobs pass

- [ ] **Verify packages published**
  - Check npm: https://www.npmjs.com/package/@wraptc/core
  - Check npm: https://www.npmjs.com/package/@wraptc/cli
  - Check npm: https://www.npmjs.com/package/@wraptc/mcp-server

- [ ] **Verify GitHub release created**
  - Check releases: https://github.com/briansunter/wraptc/releases

## Post-Setup

- [ ] **Create CHANGELOG.md** (will be auto-generated by semantic-release)

- [ ] **Add collaborators to npm packages** (optional)
  - Go to each package on npm: https://www.npmjs.com/package/@wraptc/[package-name]/access
  - Add collaborators who can publish

- [ ] **Set up branch protection rules** (recommended)
  1. Go to: https://github.com/briansunter/wraptc/settings/branches
  2. Add rule for `master` branch:
     - Require pull request reviews (optional)
     - Require status checks to pass (recommended: "Validate & Test")
     - Require branches to be up to date (recommended)

## Ongoing Workflow

After initial setup, publishing is automatic:

1. Make changes to code
2. Commit with conventional commit message:
   - `feat: ...` for features (minor bump)
   - `fix: ...` for bug fixes (patch bump)
   - `feat!: ...` for breaking changes (major bump)
3. Push to `master` branch
4. GitHub Actions handles the rest!

## Troubleshooting

If the workflow fails:

1. Check the Actions logs: https://github.com/briansunter/wraptc/actions
2. Common issues:
   - **Missing NPM_TOKEN**: Add it to GitHub Secrets
   - **Test failures**: Fix tests and push again
   - **Already published**: Make a new commit to trigger a new version

See [PUBLISHING.md](./PUBLISHING.md) for detailed documentation.

## Quick Reference

### Useful Commands

```bash
# Test locally
bun test

# Build all packages
bun run build

# Lint
bun run lint

# Dry run release (see what would be published)
bun run release:dry-run

# Manual release (not recommended, use CI/CD)
bun run release
```

### Conventional Commit Examples

```bash
# Feature (minor version bump)
git commit -m "feat: add support for custom providers"

# Bug fix (patch version bump)
git commit -m "fix: correct state file path resolution"

# Breaking change (major version bump)
git commit -m "feat!: redesign provider interface

BREAKING CHANGE: Provider methods are now async"

# Multiple commits in one PR
git commit -m "feat: add feature A"
git commit -m "fix: fix bug B"
git commit -m "docs: update README"

# All get released together when PR merges to master
```

### URLs

- **Repository**: https://github.com/briansunter/wraptc
- **Actions**: https://github.com/briansunter/wraptc/actions
- **Releases**: https://github.com/briansunter/wraptc/releases
- **Issues**: https://github.com/briansunter/wraptc/issues
- **npm @wraptc/core**: https://www.npmjs.com/package/@wraptc/core
- **npm @wraptc/cli**: https://www.npmjs.com/package/@wraptc/cli
- **npm @wraptc/mcp-server**: https://www.npmjs.com/package/@wraptc/mcp-server
